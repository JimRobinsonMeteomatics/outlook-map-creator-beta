<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Outlook Creator</title>
  <link rel="preconnect" href="https://unpkg.com" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <style>
    /* Brand palette */
    :root{
      /* Core brand */
      --mm-blue:#22394D; /* map bg */
      --mm-turquoise:#8ADBCF;
      --mm-green:#D9EB61;
      --mm-forest:#4C8C72;
      --mm-sunshine:#F5E97C;
      --mm-violet:#A49AF4;
      --mm-signal:#E3644A;
      --mm-grey1:#E6ECEA;
      --mm-grey2:#CFD9D7;
      --mm-grey3:#A8BAB6;
      --mm-grey4:#7F9590;

      /* UI theme */
      --bg:#0b1220;
      --panel:#0f1828;
      --ink:#EAF2F1;
      --muted:#9bb2ad;
      --line:#1c2a37;
      --btn:#162638;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--ink); font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    #app{display:grid; grid-template-columns:320px 1fr; height:100%}

    /* Sidebar */
    .side{background:var(--panel); border-right:1px solid var(--line); padding:14px; overflow:auto}
    .h1{font-weight:700; letter-spacing:.3px; font-size:18px; margin:0 0 8px}
    .sub{color:var(--muted); font-size:12px; margin-bottom:12px}
    .row{display:flex; gap:8px; align-items:center; margin:8px 0}
    .col{display:flex; flex-direction:column; gap:8px}
    .btn{background:var(--btn); color:var(--ink); border:1px solid var(--line); padding:8px 10px; border-radius:10px; cursor:pointer}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .btn.block{display:block; width:100%}
    .btn.small{padding:6px 8px; font-size:12px}
    .btn.ghost{background:transparent}
    .grid{display:grid; grid-template-columns:repeat(2,1fr); gap:8px}
    .legend{display:grid; grid-template-columns:repeat(6, 1fr); gap:6px}
    .swatch{height:26px; border-radius:8px; border:1px solid var(--line); cursor:pointer}
    .field{display:flex; align-items:center; justify-content:space-between; gap:8px}
    .field input[type="number"], .field select{ width:140px; background:#0c1426; border:1px solid var(--line); color:var(--ink); border-radius:8px; padding:6px 8px }
    .slider{width:100%}
    .sep{height:1px; background:var(--line); margin:12px 0}
    .hint{color:var(--muted); font-size:11px}

    /* Map */
    #map{height:100%; width:100%}
    .leaflet-container{background:var(--mm-blue)}

    /* Leaflet Draw dark styling, keep sprite icons */
    .leaflet-draw-toolbar a{background-color:#0e1730; border-color:#25314f}
    .leaflet-draw-toolbar a:hover{background-color:#132040}
    .leaflet-bar a, .leaflet-bar a:hover{color:#cfe0ff}
    .leaflet-popup-content-wrapper, .leaflet-popup-tip{background:#0e1730; color:#dfe8ff}
  </style>
</head>
<body>
<div id="app">
  <aside class="side">
    <h1 class="h1">Outlook Creator (BETA)</h1>
    <div class="sub">Draw rounded, layered polygons and export as GeoJSON or 4K PNG. This tool allows you to quickly create a weather outlook using polygons.</div>

    <div class="grid">
      <button id="draw-poly" class="btn">New polygon</button>
      <button id="draw-rect" class="btn">New rectangle</button>
      <button id="edit" class="btn">Edit</button>
      <button id="del" class="btn">Delete</button>
    </div>

    <div class="sep"></div>

    <div class="col">
      <div class="field"><label>Opacity</label><input id="opacity" class="slider" type="range" min="0.2" max="1" step="0.05" value="0.6"></div>
      <div class="field"><label>Stroke width</label><input id="stroke" type="number" min="0" max="8" value="2"></div>
    </div>

    <div class="row" style="margin-top:8px"><span class="hint">Brand colors</span></div>
    <div id="legend" class="legend"></div>

    <div class="sep"></div>

    <div class="grid">
      <button id="bring-front" class="btn small">Bring front</button>
      <button id="send-back" class="btn small">Send back</button>
      <button id="smooth" class="btn small">Smooth</button>
      <button id="duplicate" class="btn small">Duplicate</button>
    </div>

    <div class="field" style="margin-top:10px"><label>Smooth passes</label><input id="smooth-iters" class="slider" type="range" min="0" max="4" step="1" value="1"></div>

    <div class="sep"></div>

    <div class="grid">
      <button id="export" class="btn">Export GeoJSON</button>
      <label class="btn" for="importFile" style="text-align:center">Import GeoJSON</label>
      <input id="importFile" type="file" accept="application/geo+json,application/json,.geojson" style="display:none"/>
      <button id="clear" class="btn ghost">Clear</button>
    </div>

    <div class="sep"></div>

    <div class="grid">
      <button id="export-png" class="btn">Export PNG 3840×2160</button>
      <label class="btn" for="clipLand" style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="clipLand" checked style="accent-color:#4ad4ff;transform:scale(1.2)"/> Clip to land</label>
    </div>
    <div id="landStatus" class="hint" style="margin-top:6px"></div>

    <div class="sep"></div>

    <div class="col">
      <div class="hint">Click a shape to select it. Use swatches to recolor. PNG export captures the map only.</div>
    </div>
  </aside>
  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
<script src="https://unpkg.com/dom-to-image-more@2.8.0/dist/dom-to-image-more.min.js"></script>
<script>
  // Map setup
  const map = L.map('map', { zoomControl: true }).setView([39.5, -98.35], 4)
  // You can swap the basemap per your preference
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors', subdomains:['a','b','c'], crossOrigin: true
  }).addTo(map)

  // Layers and state
  const drawnItems = new L.FeatureGroup(); map.addLayer(drawnItems)
  let activeLayer = null
  let landMask = null
  let editHandler = null
  let isEditing = false
  let currentColor = getBrandColors()[0].hex // default

  // Load land mask (CORS-safe)
  fetch('https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_50m_land.geojson')
    .then(r => r.json()).then(data => { landMask = data; document.getElementById('landStatus').innerText = 'Land mask ready.' })
    .catch(() => document.getElementById('landStatus').innerText = 'Land mask failed to load. Clipping disabled.')

  // Drawing
  const drawOpts = {
    edit: { featureGroup: drawnItems, edit: true, remove: false },
    draw: {
      polygon: { allowIntersection: false, showArea: false, shapeOptions: baseShape() },
      rectangle: { shapeOptions: baseShape() },
      polyline: false, circle: false, marker: false, circlemarker: false
    }
  }
  map.addControl(new L.Control.Draw(drawOpts))

  function baseShape(){
    return {
      color: '#ffffff',
      weight: parseFloat(document.getElementById('stroke').value),
      fillColor: currentColor,
      fillOpacity: parseFloat(document.getElementById('opacity').value)
    }
  }
  function applyStyle(layer){
    layer.setStyle({
      color:'#ffffff',
      weight: parseFloat(document.getElementById('stroke').value),
      fillColor: currentColor,
      fillOpacity: parseFloat(document.getElementById('opacity').value)
    })
  }
  function makeInteractive(layer){ layer.on('click', () => { activeLayer = layer; highlight(layer) }) }
  function highlight(layer){ drawnItems.eachLayer(l => l.setStyle && l.setStyle({ dashArray: null })); if(layer.setStyle) layer.setStyle({ dashArray: '4 3' }) }

  map.on(L.Draw.Event.CREATED, async e => {
    let layer = e.layer
    if(document.getElementById('clipLand').checked && landMask && layer.toGeoJSON){
      try{
        const clipped = turf.intersect(landMask, layer.toGeoJSON())
        if(clipped){ let tmp; L.geoJSON(clipped).eachLayer(l => tmp = l); if(tmp) layer = tmp }
      }catch(err){ console.warn('Clip failed', err) }
    }
    applyStyle(layer); drawnItems.addLayer(layer); makeInteractive(layer); activeLayer = layer; highlight(layer)
  })

  // Sidebar actions
  document.getElementById('draw-poly').onclick = () => new L.Draw.Polygon(map, drawOpts.draw.polygon).enable()
  document.getElementById('draw-rect').onclick = () => new L.Draw.Rectangle(map, drawOpts.draw.rectangle).enable()
  document.getElementById('edit').onclick = () => {
    if(!isEditing){
      editHandler = new L.EditToolbar.Edit(map, { featureGroup: drawnItems })
      editHandler.enable(); isEditing = true; document.getElementById('edit').textContent = 'Done Editing'
    } else {
      try{ editHandler && editHandler.save && editHandler.save() }catch(e){}
      if(editHandler && editHandler.disable) editHandler.disable(); isEditing=false; document.getElementById('edit').textContent='Edit'
    }
  }
  document.getElementById('del').onclick = () => { if(!activeLayer) return; drawnItems.removeLayer(activeLayer); activeLayer = null }
  document.getElementById('bring-front').onclick = () => { if(activeLayer && activeLayer.bringToFront) activeLayer.bringToFront() }
  document.getElementById('send-back').onclick = () => { if(activeLayer && activeLayer.bringToBack) activeLayer.bringToBack() }
  document.getElementById('duplicate').onclick = () => {
    if(!activeLayer) return
    const gj = activeLayer.toGeoJSON()
    L.geoJSON(gj, { style: activeLayer.options }).eachLayer(l => { drawnItems.addLayer(l); makeInteractive(l); l.setStyle(activeLayer.options); activeLayer = l; highlight(l) })
  }
  ;['opacity','stroke'].forEach(id => document.getElementById(id).addEventListener('input', () => { if(activeLayer) applyStyle(activeLayer) }))

  // Build brand legend
  const palette = getBrandColors()
  const legend = document.getElementById('legend')
  palette.forEach(c => {
    const div = document.createElement('div')
    div.className = 'swatch'
    div.style.background = c.hex
    div.title = c.name
    div.onclick = () => { currentColor = c.hex; if(activeLayer) applyStyle(activeLayer) }
    legend.appendChild(div)
  })

  function getBrandColors(){
    return [
      {name:'MM Green',       hex: getComputedStyle(document.documentElement).getPropertyValue('--mm-green').trim() || '#D9EB61'},
      {name:'MM Forest',      hex: getComputedStyle(document.documentElement).getPropertyValue('--mm-forest').trim() || '#4C8C72'},
      {name:'MM Sunshine',    hex: getComputedStyle(document.documentElement).getPropertyValue('--mm-sunshine').trim() || '#F5E97C'},
      {name:'MM Violet',      hex: getComputedStyle(document.documentElement).getPropertyValue('--mm-violet').trim() || '#A49AF4'},
      {name:'MM Signal Red',  hex: getComputedStyle(document.documentElement).getPropertyValue('--mm-signal').trim() || '#E3644A'}
    ]
  }

  // Export GeoJSON
  document.getElementById('export').onclick = () => {
    const fc = { type:'FeatureCollection', features:[] }
    drawnItems.eachLayer(layer => { if(!layer.toGeoJSON) return; const gj = layer.toGeoJSON(); gj.properties = Object.assign({}, gj.properties, { _style:{ color: layer.options.color, weight: layer.options.weight, fillColor: layer.options.fillColor, fillOpacity: layer.options.fillOpacity } }); fc.features.push(gj) })
    const blob = new Blob([JSON.stringify(fc,null,2)], {type:'application/geo+json'})
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='outlook.geojson'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url)
  }

  // Import GeoJSON
  document.getElementById('importFile').addEventListener('change', e => {
    const file = e.target.files[0]; if(!file) return
    const reader = new FileReader()
    reader.onload = () => {
      let data; try{ data = JSON.parse(reader.result) }catch(err){ return }
      const layer = L.geoJSON(data, { style: f => { const s = (f.properties && f.properties._style) || {}; return { color: s.color || '#ffffff', weight: s.weight || 1, fillColor: s.fillColor || palette[0].hex, fillOpacity: s.fillOpacity ?? 0.6 } } }).addTo(drawnItems)
      layer.eachLayer(l => makeInteractive(l))
    }
    reader.readAsText(file); e.target.value = ''
  })

  // Clear
  document.getElementById('clear').onclick = () => { drawnItems.clearLayers(); activeLayer = null; if(isEditing && editHandler){ try{editHandler.disable()}catch(e){}; isEditing=false; document.getElementById('edit').textContent='Edit' } }

  // Ensure proper sizing after layout
  setTimeout(() => map.invalidateSize(), 0)

  // PNG export 3840 × 2160
  document.getElementById('export-png').onclick = () => {
    const mapEl = document.getElementById('map')
    const scale = 3840 / map.getSize().x
    domtoimage.toPng(mapEl, { width:3840, height:2160, style:{ transform:'scale('+scale+')', transformOrigin:'top left', background: getComputedStyle(document.documentElement).getPropertyValue('--mm-blue') }, fetchRequestInit:{mode:'cors'}, cacheBust:true })
      .then(dataUrl => { const a = document.createElement('a'); a.href=dataUrl; a.download='outlook_3840x2160.png'; a.click() })
      .catch(err => console.error('PNG export failed', err))
  }

  // Smoothing
  function chaikin(points){ if(points.length < 3) return points; const closed = !points[0].equals(points[points.length-1]) ? points.concat([points[0]]) : points; const out = []; for(let i=0;i<closed.length-1;i++){ const p0 = closed[i], p1 = closed[i+1]; const Q = L.latLng(0.75*p0.lat + 0.25*p1.lat, 0.75*p0.lng + 0.25*p1.lng); const R = L.latLng(0.25*p0.lat + 0.75*p1.lat, 0.25*p0.lng + 0.75*p1.lng); out.push(Q,R) } out.push(out[0]); return out }
  function smoothLayer(layer,iters){ if(!(layer instanceof L.Polygon)) return; let latlngs = layer.getLatLngs(); const rings = Array.isArray(latlngs[0]) ? latlngs : [latlngs]; const newRings = rings.map(r => { let pts = r.slice(); for(let i=0;i<iters;i++) pts = chaikin(pts); return pts }); layer.setLatLngs(newRings); layer.redraw() }
  document.getElementById('smooth').onclick = () => { if(!activeLayer) return; const it = parseInt(document.getElementById('smooth-iters').value,10); smoothLayer(activeLayer,it) }
</script>
</body>
</html>
